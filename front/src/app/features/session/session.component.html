<div class="min-h-screen p-6" style="background-color: rgb(248, 250, 252);">

  <!-- HEADER -->
  <div class="mb-6">
    <h1 class="text-3xl font-black font-montserrat" style="color: rgb(15, 23, 41);">
      Sesiones
    </h1>
  </div>

  <!-- KPIs CARDS -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 sm:gap-4 mb-6">
    <!-- Total Sesiones -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs sm:text-sm font-medium text-gray-600">Total Sesiones</p>
          <p class="text-xl sm:text-2xl font-bold mt-1 sm:mt-2" style="color: #6aa591">{{ stats().total }}</p>
        </div>
        <div class="p-2 sm:p-3 bg-teal-100 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-5 w-5 sm:h-6 sm:w-6 text-teal-600">
            <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
            <line x1="16" x2="16" y1="2" y2="6"></line>
            <line x1="8" x2="8" y1="2" y2="6"></line>
            <line x1="3" x2="21" y1="10" y2="10"></line>
          </svg>
        </div>
      </div>
    </div>

    <!-- Completadas -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs sm:text-sm font-medium text-gray-600">Completadas</p>
          <p class="text-xl sm:text-2xl font-bold mt-1 sm:mt-2" style="color: #16a34a">{{ kpis().sesiones_completadas }}</p>
        </div>
        <div class="p-2 sm:p-3 bg-green-100 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-5 w-5 sm:h-6 sm:w-6 text-green-600">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
      </div>
    </div>

    <!-- Canceladas -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs sm:text-sm font-medium text-gray-600">Canceladas</p>
          <p class="text-xl sm:text-2xl font-bold mt-1 sm:mt-2" style="color: #dc2626">{{ kpis().sesiones_canceladas }}</p>
        </div>
        <div class="p-2 sm:p-3 bg-red-100 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-5 w-5 sm:h-6 sm:w-6 text-red-600">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" x2="9" y1="9" y2="15"></line>
            <line x1="9" x2="15" y1="9" y2="15"></line>
          </svg>
        </div>
      </div>
    </div>

    <!-- Ingresos Brutos -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs sm:text-sm font-medium text-gray-600">Ingresos Brutos</p>
          <p class="text-xl sm:text-2xl font-bold mt-1 sm:mt-2" style="color: #4b5563">{{ kpis().ingresos_brutos.toFixed(2) }}€</p>
        </div>
        <div class="p-2 sm:p-3 bg-gray-100 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-5 w-5 sm:h-6 sm:w-6 text-gray-600">
            <line x1="12" x2="12" y1="2" y2="22"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Ingresos Netos -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs sm:text-sm font-medium text-gray-600">Ingresos Netos</p>
          <p class="text-xl sm:text-2xl font-bold mt-1 sm:mt-2" style="color: #15803d">{{ kpis().ingresos_netos.toFixed(2) }}€</p>
        </div>
        <div class="p-2 sm:p-3 bg-emerald-100 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="h-5 w-5 sm:h-6 sm:w-6 text-emerald-600">
            <path d="M19 5L5 19"></path>
            <circle cx="6.5" cy="6.5" r="2.5"></circle>
            <circle cx="17.5" cy="17.5" r="2.5"></circle>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS CARD -->
  <div class="card-elevated p-4 mb-6">
    <div class="flex flex-col gap-4">
      <!-- Fila 1: Filtros -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-start">
        <!-- Clínica -->
        <div>
          <app-clinic-selector [control]="clinicControl" [clinics]="clinics()" label="Clínica"
            placeholder="Todas las clínicas" size="sm" [multiple]="true" (applied)="onClinicFilterApplied()">
          </app-clinic-selector>
        </div>

        <!-- Estado -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Estado</label>
          <select (change)="onFilterChange('status', $any($event.target).value || null)"
            [value]="filters().status || ''"
            class="border-input h-9 rounded-md border bg-transparent px-3 py-2 text-sm w-full"
            style="border-color: rgb(225, 231, 239); border-radius: 0.75rem;">
            <option value="">Todos los estados</option>
            <option value="completada">Completada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>

        <!-- Método de Pago -->
        <div class="relative">
          <label class="block text-sm font-medium text-gray-700 mb-2">Método de pago</label>
          <button type="button" (click)="togglePaymentDropdown()"
            class="border-input h-9 rounded-md border bg-transparent px-3 py-2 text-sm w-full flex items-center justify-between"
            style="border-color: rgb(225, 231, 239); border-radius: 0.75rem;">
            <span [class.text-gray-400]="filters().paymentMethods.length === 0">
              {{ getSelectedPaymentMethodsLabel() }}
            </span>
            <svg class="h-4 w-4" style="color: rgb(101, 117, 139);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>

          @if (paymentDropdownOpen()) {
          <div class="fixed inset-0 z-40" (click)="applyPaymentMethodsFilter()"></div>
          <div class="absolute z-50 mt-1 w-full bg-white border rounded-md shadow-lg" style="border-color: rgb(225, 231, 239);">
            <div class="py-1">
              @for (option of paymentMethodOptions; track option.value) {
              <label class="flex items-center px-3 py-2 hover:bg-slate-50 cursor-pointer">
                <input type="checkbox"
                  [checked]="isPaymentMethodSelected(option.value)"
                  (change)="togglePaymentMethod(option.value)"
                  class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm">{{ option.label }}</span>
              </label>
              }
            </div>
            <div class="border-t px-3 py-2 flex justify-end" style="border-color: rgb(225, 231, 239);">
              <button type="button" (click)="applyPaymentMethodsFilter()"
                class="px-3 py-1.5 text-sm rounded-md text-white"
                style="background-color: rgb(60, 131, 246);">
                Aplicar
              </button>
            </div>
          </div>
          }

          @if (getSelectedPaymentMethodsChips().length > 0) {
          <div class="flex flex-wrap gap-1.5 mt-2">
            @for (chip of getSelectedPaymentMethodsChips(); track chip.value) {
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-sky-50 border border-sky-200 rounded-md text-xs text-sky-700">
              {{ chip.label }}
              <button type="button" (click)="removePaymentMethod(chip.value)"
                class="ml-0.5 text-sky-500 hover:text-sky-700 font-bold leading-none">
                ×
              </button>
            </span>
            }
          </div>
          }
        </div>

        <!-- Fecha Desde -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
          <input type="date" [value]="filters().dateFrom"
            (change)="onFilterChange('dateFrom', $any($event.target).value)"
            class="border-input h-9 rounded-md border bg-transparent px-3 py-2 text-sm w-full"
            [class.border-red-500]="dateFromError()"
            style="border-color: rgb(225, 231, 239); border-radius: 0.75rem;">
          @if (dateFromError()) {
          <p class="text-red-600 text-xs mt-1">{{ dateFromError() }}</p>
          }
        </div>

        <!-- Fecha Hasta -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
          <input type="date" [value]="filters().dateTo"
            (change)="onFilterChange('dateTo', $any($event.target).value)"
            class="border-input h-9 rounded-md border bg-transparent px-3 py-2 text-sm w-full"
            [class.border-red-500]="dateToError()"
            style="border-color: rgb(225, 231, 239); border-radius: 0.75rem;">
          @if (dateToError()) {
          <p class="text-red-600 text-xs mt-1">{{ dateToError() }}</p>
          }
        </div>
      </div>

      <!-- Fila 2: Botones -->
      <div class="flex justify-end gap-2">
        <button (click)="clearFilters()"
          class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 py-2 whitespace-nowrap border transition-colors hover:bg-slate-50"
          style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
          Limpiar
        </button>
        <button (click)="downloadExcel()" [disabled]="isDownloading() || totalSessions() === 0"
          class="inline-flex items-center justify-center rounded-md text-sm font-medium h-9 px-4 py-2 whitespace-nowrap gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
          style="background-color: rgb(60, 131, 246); color: rgb(255, 255, 255); border-radius: 0.5rem; font-weight: 500; box-shadow: rgba(15, 23, 41, 0.1) 0px 4px 6px -1px;">
          @if (isDownloading()) {
          <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Descargando...
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Descargar Excel
          }
        </button>
      </div>
    </div>
  </div>

  <!-- TABLA -->
  <div class="card-elevated overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full" style="min-width: 700px;">
        <thead style="background-color: rgba(225, 231, 239, 0.5);">
          <tr>
            <th class="text-left p-3 lg:p-4 text-sm font-medium" style="color: rgb(101, 117, 139);">Paciente</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium hidden md:table-cell" style="color: rgb(101, 117, 139);">Tipo</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium" style="color: rgb(101, 117, 139);">Fecha</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium hidden lg:table-cell" style="color: rgb(101, 117, 139);">Clínica</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium" style="color: rgb(101, 117, 139);">Estado</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium" style="color: rgb(101, 117, 139);">Precio</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium hidden xl:table-cell" style="color: rgb(101, 117, 139);">Comisión</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium hidden md:table-cell" style="color: rgb(101, 117, 139);">Neto</th>
            <th class="text-left p-3 lg:p-4 text-sm font-medium hidden sm:table-cell" style="color: rgb(101, 117, 139);">Pago</th>
          </tr>
        </thead>
        <tbody>
          @if (isLoading()) {
          <tr>
            <td colspan="9" class="p-8 text-center">
              <div class="flex items-center justify-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: rgb(60, 131, 246);"></div>
              </div>
            </td>
          </tr>
          } @else if (sessions().length === 0) {
          <tr>
            <td colspan="9" class="p-8 text-center">
              <p class="text-base" style="color: rgb(101, 117, 139);">
                No hay sesiones que mostrar
              </p>
            </td>
          </tr>
          } @else {
          @for (session of sessions(); track session.SessionDetailData.session_id; let i = $index) {
          <tr class="animate-fade-in cursor-pointer transition-colors hover:bg-slate-50"
            [style.animation-delay.ms]="i * 30" style="border-bottom: 1px solid rgb(225, 231, 239);">

            <!-- Paciente -->
            <td class="p-3 lg:p-4">
              <span class="text-sm font-medium" style="color: rgb(15, 23, 41);">
                {{ session.SessionDetailData.PatientData.name }}
              </span>
            </td>

            <!-- Tipo/Modo -->
            <td class="p-3 lg:p-4 hidden md:table-cell">
              @if (session.SessionDetailData.mode === 'presencial') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-blue-50 text-blue-600">
                Presencial
              </span>
              } @else if (session.SessionDetailData.mode === 'online') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-purple-50 text-purple-600">
                Online
              </span>
              } @else if (session.SessionDetailData.mode === 'telefónica') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-cyan-50 text-cyan-600">
                Telefónica
              </span>
              } @else {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-gray-50 text-gray-500">
                {{ formatMode(session.SessionDetailData.mode) }}
              </span>
              }
            </td>

            <!-- Fecha -->
            <td class="p-3 lg:p-4">
              <span class="text-sm" style="color: rgb(101, 117, 139);">
                {{ formatDate(session.SessionDetailData.session_date) }}
              </span>
            </td>

            <!-- Clínica -->
            <td class="p-3 lg:p-4 hidden lg:table-cell">
              <div class="flex items-center gap-2">
                @if (session.SessionDetailData.ClinicDetailData.clinic_color) {
                <div class="w-3 h-3 rounded-full flex-shrink-0"
                  [style.background-color]="session.SessionDetailData.ClinicDetailData.clinic_color"></div>
                }
                <span class="text-sm" style="color: rgb(15, 23, 41);">
                  {{ session.SessionDetailData.ClinicDetailData.clinic_name || 'Sin clínica' }}
                </span>
              </div>
            </td>

            <!-- Estado -->
            <td class="p-3 lg:p-4">
              @if (session.SessionDetailData.status === 'completada') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-green-50 text-green-600">
                Completada
              </span>
              } @else if (session.SessionDetailData.status === 'cancelada') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-red-50 text-red-600">
                Cancelada
              </span>
              } @else {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-gray-50 text-gray-500">
                {{ getStatusText(session.SessionDetailData.status) }}
              </span>
              }
            </td>

            <!-- Precio -->
            <td class="p-3 lg:p-4">
              <span class="text-sm font-medium" style="color: rgb(101, 117, 139);">
                @if (session.SessionDetailData.price) {
                {{ session.SessionDetailData.price }}€
                } @else {
                -
                }
              </span>
            </td>

            <!-- Comisión -->
            <td class="p-3 lg:p-4 hidden xl:table-cell">
              @if (session.SessionDetailData.price && session.SessionDetailData.net_price) {
              <span class="text-sm font-medium text-orange-600">
                {{ calcularComision(session.SessionDetailData.price, session.SessionDetailData.net_price).toFixed(2) }}€
              </span>
              } @else {
              <span class="text-sm" style="color: rgb(101, 117, 139);">-</span>
              }
            </td>

            <!-- Neto -->
            <td class="p-3 lg:p-4 hidden md:table-cell">
              @if (session.SessionDetailData.net_price) {
              <span class="text-sm font-semibold text-green-600">
                {{ session.SessionDetailData.net_price.toFixed(2) }}€
              </span>
              @if (session.SessionDetailData.ClinicDetailData.clinic_percentage) {
              <span class="text-xs ml-1" style="color: rgb(101, 117, 139);">
                ({{ session.SessionDetailData.ClinicDetailData.clinic_percentage }}%)
              </span>
              }
              } @else {
              <span class="text-sm" style="color: rgb(101, 117, 139);">-</span>
              }
            </td>

            <!-- Método de Pago -->
            <td class="p-3 lg:p-4 hidden sm:table-cell">
              @if (session.SessionDetailData.payment_method === 'bizum') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-emerald-50 text-emerald-600">
                Bizum
              </span>
              } @else if (session.SessionDetailData.payment_method === 'transferencia') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-blue-50 text-blue-600">
                Transferencia
              </span>
              } @else if (session.SessionDetailData.payment_method === 'tarjeta') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-violet-50 text-violet-600">
                Tarjeta
              </span>
              } @else if (session.SessionDetailData.payment_method === 'efectivo') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-amber-50 text-amber-600">
                Efectivo
              </span>
              } @else if (session.SessionDetailData.payment_method === 'pendiente') {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-orange-50 text-orange-600">
                Pendiente
              </span>
              } @else {
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-semibold bg-gray-50 text-gray-500">
                {{ formatPaymentMethod(session.SessionDetailData.payment_method) }}
              </span>
              }
            </td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>

    <!-- PAGINACION -->
    <div class="p-3 sm:p-4 border-t flex flex-col sm:flex-row items-center justify-between gap-2" style="border-color: rgb(225, 231, 239);">
      <div class="text-sm" style="color: rgb(101, 117, 139);">
        Mostrando {{ sessions().length }} de {{ totalSessions() }} sesiones
      </div>

      <div class="flex gap-2">
        <button (click)="goToPage(currentPage() - 1)" [disabled]="currentPage() === 1"
          class="px-3 py-1 rounded-md border text-sm transition-opacity"
          [class.opacity-50]="currentPage() === 1"
          [class.cursor-not-allowed]="currentPage() === 1"
          style="border-color: rgb(225, 231, 239);">
          Anterior
        </button>

        <button (click)="goToPage(currentPage() + 1)" [disabled]="currentPage() >= totalPages()"
          class="px-3 py-1 rounded-md border text-sm transition-opacity"
          [class.opacity-50]="currentPage() >= totalPages()"
          [class.cursor-not-allowed]="currentPage() >= totalPages()"
          style="border-color: rgb(225, 231, 239);">
          Siguiente
        </button>
      </div>
    </div>
  </div>
</div>
