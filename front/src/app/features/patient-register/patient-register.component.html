<div class="min-h-screen p-4 sm:p-6" style="background-color: rgb(248, 250, 252);">

  <!-- LOADING -->
  @if (isLoading()) {
  <div class="flex items-center justify-center min-h-screen">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto" style="border-color: rgb(60, 131, 246);">
      </div>
      <p class="mt-4 text-base" style="color: rgb(101, 117, 139);">Validando invitacion...</p>
    </div>
  </div>
  }

  <!-- SUCCESS MESSAGE -->
  @if (!isLoading() && successMessage()) {
  <div class="flex items-center justify-center min-h-screen">
    <div class="card-elevated p-8 max-w-md w-full text-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" class="mx-auto mb-4 text-green-500">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="m9 12 2 2 4-4"></path>
      </svg>
      <h2 class="text-2xl font-bold mb-2" style="color: rgb(15, 23, 41);">Registro exitoso</h2>
      <p class="text-base" style="color: rgb(101, 117, 139);">{{ successMessage() }}</p>
    </div>
  </div>
  }

  <!-- ERROR -->
  @if (!isLoading() && !isValidToken() && errorMessage() && !successMessage()) {
  <div class="flex items-center justify-center min-h-screen">
    <div class="card-elevated p-8 max-w-md w-full text-center">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" class="mx-auto mb-4 text-red-500">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" x2="9" y1="9" y2="15"></line>
        <line x1="9" x2="15" y1="9" y2="15"></line>
      </svg>
      <h2 class="text-2xl font-bold mb-2" style="color: rgb(15, 23, 41);">Enlace no valido</h2>
      <p class="text-base" style="color: rgb(101, 117, 139);">{{ errorMessage() }}</p>
    </div>
  </div>
  }

  <!-- REGISTRATION FORM + PREVIEW (2 COLUMNS) -->
  @if (!isLoading() && isValidToken() && !successMessage()) {

  <!-- TABS - Solo visible en móvil/tablet -->
  <div class="xl:hidden mb-4 mx-auto" style="max-width: 1400px;">
    <div class="flex border-b-2" style="border-color: rgb(225, 231, 239);">
      <!-- Tab: Formulario -->
      <button type="button" (click)="switchTab('form')"
        class="flex-1 py-3 px-4 text-sm font-medium transition-all relative"
        [style.color]="activeTab === 'form' ? 'rgb(60, 131, 246)' : 'rgb(101, 117, 139)'">
        <div class="flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          <span>Formulario</span>
        </div>
        @if (activeTab === 'form') {
        <div class="absolute bottom-0 left-0 right-0 h-0.5" style="background-color: rgb(60, 131, 246);"></div>
        }
      </button>

      <!-- Tab: Vista Previa -->
      <button type="button" (click)="switchTab('preview')"
        class="flex-1 py-3 px-4 text-sm font-medium transition-all relative"
        [style.color]="activeTab === 'preview' ? 'rgb(60, 131, 246)' : 'rgb(101, 117, 139)'">
        <div class="flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
          </svg>
          <span>Vista Previa</span>
        </div>
        @if (activeTab === 'preview') {
        <div class="absolute bottom-0 left-0 right-0 h-0.5" style="background-color: rgb(60, 131, 246);"></div>
        }
      </button>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-[500px_1fr] gap-6 mx-auto" style="max-width: 1400px;">

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- COLUMNA IZQUIERDA: FORMULARIO -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div class="card-elevated p-6 sm:p-8" [class.hidden]="activeTab !== 'form'" [class.xl:block]="true">
      <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-black font-montserrat mb-2" style="color: rgb(15, 23, 41);">
          Registro de Paciente
        </h1>
        <p class="text-sm sm:text-base" style="color: rgb(101, 117, 139);">
          Completa todos tus datos, descarga el documento PDF y dale a enviar para enviar.</p>
      </div>

      <!-- Clinic Info Banner -->
      @if (clinicName()) {
      <div class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
        <div class="flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            class="text-blue-600 flex-shrink-0">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <div>
            <p class="text-sm font-medium" style="color: rgb(15, 23, 41);">
              Clinica asignada
            </p>
            <p class="text-base font-bold" style="color: rgb(60, 131, 246);">
              {{ clinicName() }}
            </p>
          </div>
        </div>
      </div>
      }

      @if (errorMessage()) {
      <div class="mb-4 p-3 rounded-md bg-red-50 text-red-600 text-sm">
        {{ errorMessage() }}
      </div>
      }

      <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
        <!-- Personal Data Section -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">Datos personales</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- First Name -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Nombre <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="first_name"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('first_name')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('first_name')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('first_name') }}</p>
              }
            </div>

            <!-- Last Name -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Apellidos <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="last_name"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('last_name')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('last_name')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('last_name') }}</p>
              }
            </div>

            <!-- Email -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Email <span class="text-red-500">*</span>
              </label>
              <input type="email" formControlName="email"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('email')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('email')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('email') }}</p>
              }
            </div>

            <!-- Phone -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Telefono <span class="text-red-500">*</span>
              </label>
              <input type="tel" formControlName="phone" placeholder="666123456"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('phone')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('phone')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('phone') }}</p>
              }
            </div>

            <!-- DNI -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                DNI <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="dni" placeholder="12345678A"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('dni')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('dni')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('dni') }}</p>
              }
            </div>

            <!-- Birth Date -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Fecha de nacimiento <span class="text-red-500">*</span>
              </label>
              <input type="date" formControlName="birth_date"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('birth_date')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('birth_date')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('birth_date') }}</p>
              }
            </div>

            <!-- Age Status Indicator -->
            @if (registerForm.get('birth_date')?.value) {
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Estado de edad
              </label>
              <div class="flex items-center h-9 px-3 py-2 text-sm bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-center gap-2">
                  @if (isMinor()) {
                  <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                  <span class="text-amber-700 font-medium">Menor de edad</span>
                  } @else {
                  <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                  <span class="text-green-700 font-medium">Mayor de edad</span>
                  }
                  <span class="text-gray-500">({{ calculatedAge() }} años)</span>
                </div>
              </div>
            </div>
            }

            <!-- Gender -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Genero <span class="text-red-500">*</span>
              </label>
              <select formControlName="gender" class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('gender')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                <option value="">Seleccionar...</option>
                @for (option of genderOptions; track option.value) {
                <option [value]="option.value">{{ option.label }}</option>
                }
              </select>
              @if (getFieldError('gender')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('gender') }}</p>
              }
            </div>

            <!-- Occupation -->
            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Ocupacion
              </label>
              <input type="text" formControlName="occupation"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
            </div>
          </div>
        </div>

        <!-- Progenitors Section (only for minors) -->
        @if (isMinor()) {
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">
            Informacion de Progenitores
          </h3>

          <!-- Progenitor 1 (Required) -->
          <div class="mb-4">
            <h4 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: rgb(101, 117, 139);">
              <span class="text-amber-600">Progenitor 1</span>
              <span class="text-red-500 text-xs">(Obligatorio)</span>
            </h4>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="sm:col-span-2 lg:col-span-1">
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Nombre completo <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="progenitor1_full_name" placeholder="Ej: Maria Gonzalez Lopez"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('progenitor1_full_name')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('progenitor1_full_name')) {
                <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor1_full_name') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  DNI / NIE <span class="text-red-500">*</span>
                </label>
                <input type="text" formControlName="progenitor1_dni" placeholder="Ej: 98765432B"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('progenitor1_dni')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('progenitor1_dni')) {
                <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor1_dni') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Telefono <span class="text-red-500">*</span>
                </label>
                <input type="tel" formControlName="progenitor1_phone" placeholder="Ej: 677888999"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('progenitor1_phone')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('progenitor1_phone')) {
                <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor1_phone') }}</p>
                }
              </div>
            </div>
          </div>

          <!-- Progenitor 2 (Optional) -->
          <div>
            <h4 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: rgb(101, 117, 139);">
              <span class="text-amber-600">Progenitor 2</span>
              <span class="text-gray-500 text-xs">(Opcional)</span>
            </h4>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="sm:col-span-2 lg:col-span-1">
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Nombre completo
                </label>
                <input type="text" formControlName="progenitor2_full_name" placeholder="Ej: Carlos Martinez Ruiz"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('progenitor2_full_name')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('progenitor2_full_name')) {
                <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor2_full_name') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  DNI / NIE
                </label>
                <input type="text" formControlName="progenitor2_dni" placeholder="Ej: 87654321C"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('progenitor2_dni')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('progenitor2_dni')) {
                <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor2_dni') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Telefono
                </label>
                <input type="tel" formControlName="progenitor2_phone" placeholder="Ej: 688777666"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('progenitor2_phone')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('progenitor2_phone')) {
                <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor2_phone') }}</p>
                }
              </div>
            </div>
          </div>
        </div>
        }

        <!-- Address Section -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">Direccion</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Calle <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="street"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('street')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('street')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('street') }}</p>
              }
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Numero <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="street_number"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('street_number')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('street_number')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('street_number') }}</p>
              }
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Puerta
              </label>
              <input type="text" formControlName="door"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Codigo postal <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="postal_code" placeholder="28001"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('postal_code')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('postal_code')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('postal_code') }}</p>
              }
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Ciudad <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="city"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('city')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('city')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('city') }}</p>
              }
            </div>

            <div>
              <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                Provincia <span class="text-red-500">*</span>
              </label>
              <input type="text" formControlName="province"
                class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                [class.border-red-500]="getFieldError('province')"
                style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              @if (getFieldError('province')) {
              <p class="mt-1 text-xs text-red-500">{{ getFieldError('province') }}</p>
              }
            </div>
          </div>
        </div>

        <!-- Consent Section -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">
            Consentimientos y autorizaciones
          </h3>

          <div class="space-y-4">
            @if (isMinor()) {
            <div class="flex items-start gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
              <input type="checkbox" id="consent_legal_representative" formControlName="consent_legal_representative"
                class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <label for="consent_legal_representative" class="text-sm leading-relaxed" style="color: rgb(15, 23, 41);">
                <span class="font-medium">Declaracion de tutor legal:</span> En caso de no estar presente ambos
                progenitores/tutores legales, la persona solicitante declara ser la persona responsable legal del menor
                participante y manifiesta que el resto de representantes legales, si los hay, estan conformes con el
                tratamiento.
                <span class="text-red-500">*</span>
              </label>
            </div>
            }

            <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
              <input type="checkbox" id="consent_data_protection" formControlName="consent_data_protection"
                class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <label for="consent_data_protection" class="text-sm leading-relaxed" style="color: rgb(15, 23, 41);">
                <span class="font-medium">Proteccion de datos:</span> En cumplimiento de la Ley Organica 3/2018 de
                proteccion de datos de caracter personal y garantia de los derechos digitales y del Reglamento Europeo
                RGPD 679/2016 le informamos que sus datos estan siendo objeto de tratamiento por parte de Maria Legidos
                Huertas con la finalidad de gestionar el historial clinico y un seguimiento posterior, prestarle
                nuestros servicios sanitarios, enviarles informacion, responder a sus consultas y peticiones mientras
                dure nuestra relacion y/o tengamos su consentimiento. Las bases juridicas de legitimacion son la
                relacion contractual, interes legitimo y en su caso, consentimiento del interesado. No se cederan datos
                a terceros salvo obligacion legal o autorizacion previa. Pueden ejercer sus derechos de acceso,
                rectificacion, supresion, asi como otros derechos como indica la informacion adicional: <a
                  href="https://www.adelopd.com/privacidad/psicoandante" target="_blank"
                  class="text-blue-600 underline hover:text-blue-800">www.adelopd.com/privacidad/psicoandante</a>.
                @if (isMinor()) {
                Los progenitores mediante el envio de este formulario manifiestan que han sido informados sobre el
                tratamiento de datos por parte de la empresa.
                } @else {
                El paciente, mediante el envio de este formulario manifiesta que ha sido informado sobre el tratamiento
                de datos por parte de la empresa.
                }
                <span class="text-red-500">*</span>
              </label>
            </div>

            <div class="flex items-start gap-3 p-3 bg-green-50 rounded-lg border border-green-200">
              <input type="checkbox" id="consent_service_conditions" formControlName="consent_service_conditions"
                class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <label for="consent_service_conditions" class="text-sm" style="color: rgb(15, 23, 41);">
                <span class="font-medium">He leido y acepto las CONDICIONES DEL SERVICIO</span>
                <span class="text-red-500">*</span>
                <details class="mt-2">
                  <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">
                    Ver condiciones completas
                  </summary>
                  <div class="mt-3 pl-4 border-l-2 border-green-300 text-xs leading-relaxed space-y-2"
                    style="color: rgb(101, 117, 139);">
                    <p class="font-semibold text-sm">La finalidad del presente contenido es especificar las condiciones
                      generales del funcionamiento del programa terapeutico que usted va a comenzar.</p>
                    <p><strong>COSTE DE LOS SERVICIOS:</strong> Las sesiones tendran una duracion aproximada de 1 hora
                      (entre 50-60 minutos). Se realizaran siempre bajo cita previa.</p>
                    <p><strong>METODO DE PAGO:</strong> El pago se realizara 48-24 horas ANTES de la SESION, a traves de
                      transferencia bancaria o bizum:</p>
                    <ul class="list-disc pl-5">
                      <li>Transferencia bancaria: ES65 2100 7572 7802 0012 1902</li>
                      <li>Bizum: 600402111</li>
                    </ul>
                    <p class="text-red-600 font-medium">SI LA SESION NO SE ABONA entre 48-24 horas ANTES de la sesion,
                      se le comunicara la ANULACION de la cita.</p>
                    <p><strong>CANCELACION:</strong> Debe avisar con 24 horas de antelacion.</p>
                  </div>
                </details>
              </label>
            </div>
          </div>
        </div>

        <!-- Signatures Section -->
        <div class="mb-6 border-t pt-6" style="border-color: rgb(225, 231, 239);">
          <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">
            Firmas
          </h3>

          <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <p class="text-sm" style="color: rgb(101, 117, 139);">
              <span class="font-medium">Fecha de firma:</span> {{ currentDate | date:'dd/MM/yyyy' }}
            </p>
          </div>

          @if (signatureError()) {
          <div class="mb-4 p-3 rounded-md bg-red-50 text-red-600 text-sm">
            {{ signatureError() }}
          </div>
          }

          <div class="mb-6">
            <label class="block text-sm font-medium mb-2" style="color: rgb(15, 23, 41);">
              Firma del paciente <span class="text-red-500">*</span>
            </label>
            <canvas #patientSignature (mousedown)="startDrawing($event, 'patient')"
              (mousemove)="draw($event, 'patient')" (mouseup)="stopDrawing('patient')"
              (mouseleave)="stopDrawing('patient')" (touchstart)="startDrawing($event, 'patient')"
              (touchmove)="draw($event, 'patient')" (touchend)="stopDrawing('patient')"
              class="border-2 rounded-lg w-full cursor-crosshair bg-white"
              [class.border-green-500]="hasPatientSignature()"
              style="border-color: rgb(225, 231, 239); height: 150px; touch-action: none;">
            </canvas>
            <button type="button" (click)="clearSignature('patient')"
              class="mt-2 text-sm text-red-600 hover:text-red-800">
              Borrar firma
            </button>
          </div>

          @if (isMinor()) {
          <div class="mb-6">
            <label class="block text-sm font-medium mb-2" style="color: rgb(15, 23, 41);">
              Firma del tutor/progenitor 1 <span class="text-red-500">*</span>
            </label>
            <canvas #guardian1Signature (mousedown)="startDrawing($event, 'guardian1')"
              (mousemove)="draw($event, 'guardian1')" (mouseup)="stopDrawing('guardian1')"
              (mouseleave)="stopDrawing('guardian1')" (touchstart)="startDrawing($event, 'guardian1')"
              (touchmove)="draw($event, 'guardian1')" (touchend)="stopDrawing('guardian1')"
              class="border-2 rounded-lg w-full cursor-crosshair bg-white"
              [class.border-green-500]="hasGuardian1Signature()"
              style="border-color: rgb(225, 231, 239); height: 150px; touch-action: none;">
            </canvas>
            <button type="button" (click)="clearSignature('guardian1')"
              class="mt-2 text-sm text-red-600 hover:text-red-800">
              Borrar firma
            </button>
          </div>

          }
        </div>

        <!-- Botón "Ver Vista Previa" - Solo visible en móvil/tablet -->
        <button type="button" (click)="switchTab('preview')"
          class="xl:hidden w-full py-3 mb-4 border-2 rounded-md font-medium flex items-center justify-center gap-2 transition-colors hover:bg-blue-50"
          style="border-color: rgb(60, 131, 246); color: rgb(60, 131, 246);">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
          Descarga y vista previa del Documento
        </button>

        <!-- Submit Button -->
        <div class="flex flex-col items-center sm:items-end gap-2">
          @if (!pdfDownloaded()) {
          <p class="text-xs sm:text-sm text-amber-600 text-center sm:text-right">
            Debes descargar el documento PDF antes de completar el registro
          </p>
          }
          <button type="submit" [disabled]="isSubmitting() || !pdfDownloaded()"
            class="w-full sm:w-auto inline-flex items-center justify-center rounded-md text-sm font-medium h-11 sm:h-10 px-6 py-2 whitespace-nowrap gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            style="background-color: rgb(60, 131, 246); color: rgb(255, 255, 255); border-radius: 0.5rem; font-weight: 500;">
            {{ isSubmitting() ? 'Enviando...' : 'Enviar' }}
          </button>
        </div>
      </form>
    </div>

    <!-- ═══════════════════════════════════════════════════════════════ -->
    <!-- COLUMNA DERECHA: PREVIEW DEL DOCUMENTO -->
    <!-- ═══════════════════════════════════════════════════════════════ -->
    <div [class.hidden]="activeTab !== 'preview'" [class.xl:block]="true">
      <app-patient-document-preview [registerForm]="registerForm" [isMinor]="isMinor()" [signatures]="signatures"
        [currentDate]="currentDate" [canDownload]="canDownloadPdf()" (pdfDownloaded)="onPdfDownloaded()">
      </app-patient-document-preview>
    </div>

  </div>
  }
</div>
