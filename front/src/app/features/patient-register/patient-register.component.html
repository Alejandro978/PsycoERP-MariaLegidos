<div class="min-h-screen p-4 sm:p-6" style="background-color: rgb(248, 250, 252);">

  <!-- LOADING -->
  @if (isLoading()) {
    <div class="flex items-center justify-center min-h-screen">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto" style="border-color: rgb(60, 131, 246);"></div>
        <p class="mt-4 text-base" style="color: rgb(101, 117, 139);">Validando invitacion...</p>
      </div>
    </div>
  }

  <!-- SUCCESS MESSAGE -->
  @if (!isLoading() && successMessage()) {
    <div class="flex items-center justify-center min-h-screen">
      <div class="card-elevated p-8 max-w-md w-full text-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mx-auto mb-4 text-green-500">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="m9 12 2 2 4-4"></path>
        </svg>
        <h2 class="text-2xl font-bold mb-2" style="color: rgb(15, 23, 41);">Registro exitoso</h2>
        <p class="text-base" style="color: rgb(101, 117, 139);">{{ successMessage() }}</p>
      </div>
    </div>
  }

  <!-- ERROR -->
  @if (!isLoading() && !isValidToken() && errorMessage() && !successMessage()) {
    <div class="flex items-center justify-center min-h-screen">
      <div class="card-elevated p-8 max-w-md w-full text-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mx-auto mb-4 text-red-500">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="15" x2="9" y1="9" y2="15"></line>
          <line x1="9" x2="15" y1="9" y2="15"></line>
        </svg>
        <h2 class="text-2xl font-bold mb-2" style="color: rgb(15, 23, 41);">Enlace no valido</h2>
        <p class="text-base" style="color: rgb(101, 117, 139);">{{ errorMessage() }}</p>
      </div>
    </div>
  }

  <!-- REGISTRATION FORM + PREVIEW (2 COLUMNS) -->
  @if (!isLoading() && isValidToken() && !successMessage()) {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 max-w-7xl mx-auto">

      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- COLUMNA IZQUIERDA: FORMULARIO -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <div class="card-elevated p-6 sm:p-8">
        <div class="mb-6">
          <h1 class="text-2xl sm:text-3xl font-black font-montserrat mb-2" style="color: rgb(15, 23, 41);">
            Registro de Paciente
          </h1>
          <p class="text-sm sm:text-base" style="color: rgb(101, 117, 139);">
            Completa tus datos para comenzar tu proceso terapeutico
          </p>
        </div>

        @if (errorMessage()) {
          <div class="mb-4 p-3 rounded-md bg-red-50 text-red-600 text-sm">
            {{ errorMessage() }}
          </div>
        }

        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
          <!-- Personal Data Section -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">Datos personales</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <!-- First Name -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Nombre <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="first_name"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('first_name')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('first_name')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('first_name') }}</p>
                }
              </div>

              <!-- Last Name -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Apellidos <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="last_name"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('last_name')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('last_name')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('last_name') }}</p>
                }
              </div>

              <!-- Email -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Email <span class="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  formControlName="email"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('email')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('email')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('email') }}</p>
                }
              </div>

              <!-- Phone -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Telefono <span class="text-red-500">*</span>
                </label>
                <input
                  type="tel"
                  formControlName="phone"
                  placeholder="666123456"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('phone')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('phone')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('phone') }}</p>
                }
              </div>

              <!-- DNI -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  DNI <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="dni"
                  placeholder="12345678A"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('dni')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('dni')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('dni') }}</p>
                }
              </div>

              <!-- Birth Date -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Fecha de nacimiento <span class="text-red-500">*</span>
                </label>
                <input
                  type="date"
                  formControlName="birth_date"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('birth_date')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('birth_date')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('birth_date') }}</p>
                }
              </div>

              <!-- Age Status Indicator -->
              @if (registerForm.get('birth_date')?.value) {
                <div>
                  <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                    Estado de edad
                  </label>
                  <div class="flex items-center h-9 px-3 py-2 text-sm bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center gap-2">
                      @if (isMinor()) {
                        <div class="w-2 h-2 bg-amber-500 rounded-full"></div>
                        <span class="text-amber-700 font-medium">Menor de edad</span>
                      } @else {
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="text-green-700 font-medium">Mayor de edad</span>
                      }
                      <span class="text-gray-500">({{ calculatedAge() }} anos)</span>
                    </div>
                  </div>
                </div>
              }

              <!-- Gender -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Genero <span class="text-red-500">*</span>
                </label>
                <select
                  formControlName="gender"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('gender')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                  <option value="">Seleccionar...</option>
                  @for (option of genderOptions; track option.value) {
                    <option [value]="option.value">{{ option.label }}</option>
                  }
                </select>
                @if (getFieldError('gender')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('gender') }}</p>
                }
              </div>

              <!-- Occupation -->
              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Ocupacion
                </label>
                <input
                  type="text"
                  formControlName="occupation"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              </div>
            </div>
          </div>

          <!-- Progenitors Section (only for minors) -->
          @if (isMinor()) {
            <div class="mb-6">
              <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">
                Informacion de Progenitores
              </h3>

              <!-- Progenitor 1 (Required) -->
              <div class="mb-4">
                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: rgb(101, 117, 139);">
                  <span class="text-amber-600">Progenitor 1</span>
                  <span class="text-red-500 text-xs">(Obligatorio)</span>
                </h4>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                      Nombre completo <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      formControlName="progenitor1_full_name"
                      placeholder="Ej: Maria Gonzalez Lopez"
                      class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                      [class.border-red-500]="getFieldError('progenitor1_full_name')"
                      style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                    @if (getFieldError('progenitor1_full_name')) {
                      <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor1_full_name') }}</p>
                    }
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                      DNI / NIE <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      formControlName="progenitor1_dni"
                      placeholder="Ej: 98765432B"
                      class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                      [class.border-red-500]="getFieldError('progenitor1_dni')"
                      style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                    @if (getFieldError('progenitor1_dni')) {
                      <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor1_dni') }}</p>
                    }
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                      Telefono <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="tel"
                      formControlName="progenitor1_phone"
                      placeholder="Ej: 677888999"
                      class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                      [class.border-red-500]="getFieldError('progenitor1_phone')"
                      style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                    @if (getFieldError('progenitor1_phone')) {
                      <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor1_phone') }}</p>
                    }
                  </div>
                </div>
              </div>

              <!-- Progenitor 2 (Optional) -->
              <div>
                <h4 class="text-sm font-semibold mb-3 flex items-center gap-2" style="color: rgb(101, 117, 139);">
                  <span class="text-amber-600">Progenitor 2</span>
                  <span class="text-gray-500 text-xs">(Opcional)</span>
                </h4>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                      Nombre completo
                    </label>
                    <input
                      type="text"
                      formControlName="progenitor2_full_name"
                      placeholder="Ej: Carlos Martinez Ruiz"
                      class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                      [class.border-red-500]="getFieldError('progenitor2_full_name')"
                      style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                    @if (getFieldError('progenitor2_full_name')) {
                      <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor2_full_name') }}</p>
                    }
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                      DNI / NIE
                    </label>
                    <input
                      type="text"
                      formControlName="progenitor2_dni"
                      placeholder="Ej: 87654321C"
                      class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                      [class.border-red-500]="getFieldError('progenitor2_dni')"
                      style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                    @if (getFieldError('progenitor2_dni')) {
                      <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor2_dni') }}</p>
                    }
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                      Telefono
                    </label>
                    <input
                      type="tel"
                      formControlName="progenitor2_phone"
                      placeholder="Ej: 688777666"
                      class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                      [class.border-red-500]="getFieldError('progenitor2_phone')"
                      style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                    @if (getFieldError('progenitor2_phone')) {
                      <p class="mt-1 text-xs text-red-500">{{ getFieldError('progenitor2_phone') }}</p>
                    }
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Address Section -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">Direccion</h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Calle <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="street"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('street')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('street')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('street') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Numero <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="street_number"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('street_number')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('street_number')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('street_number') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Puerta
                </label>
                <input
                  type="text"
                  formControlName="door"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Codigo postal <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="postal_code"
                  placeholder="28001"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('postal_code')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('postal_code')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('postal_code') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Ciudad <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="city"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('city')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('city')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('city') }}</p>
                }
              </div>

              <div>
                <label class="block text-sm font-medium mb-1" style="color: rgb(15, 23, 41);">
                  Provincia <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  formControlName="province"
                  class="w-full h-9 rounded-md border bg-transparent px-3 py-2 text-sm"
                  [class.border-red-500]="getFieldError('province')"
                  style="border-color: rgb(225, 231, 239); border-radius: 0.5rem;">
                @if (getFieldError('province')) {
                  <p class="mt-1 text-xs text-red-500">{{ getFieldError('province') }}</p>
                }
              </div>
            </div>
          </div>

          <!-- Consent Section -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">
              Consentimientos y autorizaciones
            </h3>

            <div class="space-y-4">
              @if (isMinor()) {
                <div class="flex items-start gap-3 p-3 bg-amber-50 rounded-lg border border-amber-200">
                  <input
                    type="checkbox"
                    id="consent_legal_representative"
                    formControlName="consent_legal_representative"
                    class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                  <label for="consent_legal_representative" class="text-sm leading-relaxed" style="color: rgb(15, 23, 41);">
                    <span class="font-medium">Declaracion de tutor legal:</span> En caso de no estar presente ambos progenitores/tutores legales, la persona solicitante declara ser la persona responsable legal del menor participante y manifiesta que el resto de representantes legales, si los hay, estan conformes con el tratamiento.
                    <span class="text-red-500">*</span>
                  </label>
                </div>
              }

              <div class="flex items-start gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                <input
                  type="checkbox"
                  id="consent_data_protection"
                  formControlName="consent_data_protection"
                  class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="consent_data_protection" class="text-sm leading-relaxed" style="color: rgb(15, 23, 41);">
                  <span class="font-medium">Proteccion de datos:</span> En cumplimiento de la Ley Organica 3/2018 de proteccion de datos de caracter personal y garantia de los derechos digitales y del Reglamento Europeo RGPD 679/2016 le informamos que sus datos estan siendo objeto de tratamiento por parte de Maria Legidos Huertas con la finalidad de gestionar el historial clinico y un seguimiento posterior, prestarle nuestros servicios sanitarios, enviarles informacion, responder a sus consultas y peticiones mientras dure nuestra relacion y/o tengamos su consentimiento. Las bases juridicas de legitimacion son la relacion contractual, interes legitimo y en su caso, consentimiento del interesado. No se cederan datos a terceros salvo obligacion legal o autorizacion previa. Pueden ejercer sus derechos de acceso, rectificacion, supresion, asi como otros derechos como indica la informacion adicional: <a href="https://www.adelopd.com/privacidad/psicoandante" target="_blank" class="text-blue-600 underline hover:text-blue-800">www.adelopd.com/privacidad/psicoandante</a>.
                  @if (isMinor()) {
                    Los progenitores mediante el envio de este formulario manifiestan que han sido informados sobre el tratamiento de datos por parte de la empresa.
                  } @else {
                    El paciente, mediante el envio de este formulario manifiesta que ha sido informado sobre el tratamiento de datos por parte de la empresa.
                  }
                  <span class="text-red-500">*</span>
                </label>
              </div>

              <div class="flex items-start gap-3 p-3 bg-green-50 rounded-lg border border-green-200">
                <input
                  type="checkbox"
                  id="consent_service_conditions"
                  formControlName="consent_service_conditions"
                  class="mt-1 h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <label for="consent_service_conditions" class="text-sm" style="color: rgb(15, 23, 41);">
                  <span class="font-medium">He leido y acepto las CONDICIONES DEL SERVICIO</span>
                  <span class="text-red-500">*</span>
                  <details class="mt-2">
                    <summary class="cursor-pointer text-blue-600 hover:text-blue-800 font-medium">
                      Ver condiciones completas
                    </summary>
                    <div class="mt-3 pl-4 border-l-2 border-green-300 text-xs leading-relaxed space-y-2" style="color: rgb(101, 117, 139);">
                      <p class="font-semibold text-sm">La finalidad del presente contenido es especificar las condiciones generales del funcionamiento del programa terapeutico que usted va a comenzar.</p>
                      <p><strong>COSTE DE LOS SERVICIOS:</strong> Las sesiones tendran una duracion aproximada de 1 hora (entre 50-60 minutos). Se realizaran siempre bajo cita previa.</p>
                      <p><strong>METODO DE PAGO:</strong> El pago se realizara 48-24 horas ANTES de la SESION, a traves de transferencia bancaria o bizum:</p>
                      <ul class="list-disc pl-5">
                        <li>Transferencia bancaria: ES65 2100 7572 7802 0012 1902</li>
                        <li>Bizum: 600402111</li>
                      </ul>
                      <p class="text-red-600 font-medium">SI LA SESION NO SE ABONA entre 48-24 horas ANTES de la sesion, se le comunicara la ANULACION de la cita.</p>
                      <p><strong>CANCELACION:</strong> Debe avisar con 24 horas de antelacion.</p>
                    </div>
                  </details>
                </label>
              </div>
            </div>
          </div>

          <!-- Signatures Section -->
          <div class="mb-6 border-t pt-6" style="border-color: rgb(225, 231, 239);">
            <h3 class="text-lg font-semibold mb-4" style="color: rgb(15, 23, 41);">
              Firmas
            </h3>

            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
              <p class="text-sm" style="color: rgb(101, 117, 139);">
                <span class="font-medium">Fecha de firma:</span> {{ currentDate | date:'dd/MM/yyyy' }}
              </p>
            </div>

            @if (signatureError()) {
              <div class="mb-4 p-3 rounded-md bg-red-50 text-red-600 text-sm">
                {{ signatureError() }}
              </div>
            }

            <div class="mb-6">
              <label class="block text-sm font-medium mb-2" style="color: rgb(15, 23, 41);">
                Firma del paciente <span class="text-red-500">*</span>
              </label>
              <canvas
                #patientSignature
                (mousedown)="startDrawing($event, 'patient')"
                (mousemove)="draw($event, 'patient')"
                (mouseup)="stopDrawing('patient')"
                (mouseleave)="stopDrawing('patient')"
                (touchstart)="startDrawing($event, 'patient')"
                (touchmove)="draw($event, 'patient')"
                (touchend)="stopDrawing('patient')"
                class="border-2 rounded-lg w-full cursor-crosshair bg-white"
                [class.border-green-500]="hasPatientSignature()"
                style="border-color: rgb(225, 231, 239); height: 120px; touch-action: none;">
              </canvas>
              <button type="button" (click)="clearSignature('patient')" class="mt-2 text-sm text-red-600 hover:text-red-800">
                Borrar firma
              </button>
            </div>

            @if (isMinor()) {
              <div class="mb-6">
                <label class="block text-sm font-medium mb-2" style="color: rgb(15, 23, 41);">
                  Firma del tutor/progenitor 1 <span class="text-red-500">*</span>
                </label>
                <canvas
                  #guardian1Signature
                  (mousedown)="startDrawing($event, 'guardian1')"
                  (mousemove)="draw($event, 'guardian1')"
                  (mouseup)="stopDrawing('guardian1')"
                  (mouseleave)="stopDrawing('guardian1')"
                  (touchstart)="startDrawing($event, 'guardian1')"
                  (touchmove)="draw($event, 'guardian1')"
                  (touchend)="stopDrawing('guardian1')"
                  class="border-2 rounded-lg w-full cursor-crosshair bg-white"
                  [class.border-green-500]="hasGuardian1Signature()"
                  style="border-color: rgb(225, 231, 239); height: 120px; touch-action: none;">
                </canvas>
                <button type="button" (click)="clearSignature('guardian1')" class="mt-2 text-sm text-red-600 hover:text-red-800">
                  Borrar firma
                </button>
              </div>

              <div class="mb-6">
                <label class="block text-sm font-medium mb-2" style="color: rgb(15, 23, 41);">
                  Firma del tutor/progenitor 2 <span class="text-gray-400">(opcional)</span>
                </label>
                <canvas
                  #guardian2Signature
                  (mousedown)="startDrawing($event, 'guardian2')"
                  (mousemove)="draw($event, 'guardian2')"
                  (mouseup)="stopDrawing('guardian2')"
                  (mouseleave)="stopDrawing('guardian2')"
                  (touchstart)="startDrawing($event, 'guardian2')"
                  (touchmove)="draw($event, 'guardian2')"
                  (touchend)="stopDrawing('guardian2')"
                  class="border-2 rounded-lg w-full cursor-crosshair bg-white"
                  style="border-color: rgb(225, 231, 239); height: 120px; touch-action: none;">
                </canvas>
                <button type="button" (click)="clearSignature('guardian2')" class="mt-2 text-sm text-red-600 hover:text-red-800">
                  Borrar firma
                </button>
              </div>
            }
          </div>

          <!-- Submit Button -->
          <div class="flex justify-end">
            <button
              type="submit"
              [disabled]="isSubmitting()"
              class="inline-flex items-center justify-center rounded-md text-sm font-medium h-10 px-6 py-2 whitespace-nowrap gap-2 disabled:opacity-50"
              style="background-color: rgb(60, 131, 246); color: rgb(255, 255, 255); border-radius: 0.5rem; font-weight: 500;">
              {{ isSubmitting() ? 'Enviando...' : 'Completar Registro' }}
            </button>
          </div>
        </form>
      </div>

      <!-- ═══════════════════════════════════════════════════════════════ -->
      <!-- COLUMNA DERECHA: PREVIEW DEL DOCUMENTO -->
      <!-- ═══════════════════════════════════════════════════════════════ -->
      <div class="hidden lg:block">
        <div class="sticky top-6">
          <div class="card-elevated p-4 mb-4">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold" style="color: rgb(15, 23, 41);">
                Vista previa del documento
              </h2>
              <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">
                Tiempo real
              </span>
            </div>
            <p class="text-xs mt-1" style="color: rgb(101, 117, 139);">
              Este documento se generara como PDF al completar el registro
            </p>
          </div>

          <!-- Document Preview -->
          <div class="card-elevated overflow-hidden" style="max-height: calc(100vh - 180px);">
            <div class="overflow-y-auto p-6" style="max-height: calc(100vh - 180px);">
              <div class="bg-white border rounded-lg p-6 shadow-inner" style="font-family: 'Times New Roman', serif; font-size: 11px; line-height: 1.4;">

                <!-- Header -->
                <div class="flex justify-between items-start mb-6 pb-4 border-b">
                  <div>
                    <p class="text-base font-bold m-0" style="color: rgb(15, 23, 41);">CONSENTIMIENTO INFORMADO</p>
                    <p class="text-xs m-0 mt-1" style="color: rgb(101, 117, 139);">Servicios de Psicologia</p>
                  </div>
                  <div class="text-right">
                    <p class="text-xs font-semibold m-0">Maria Legidos Huertas</p>
                    <p class="text-xs m-0" style="color: rgb(101, 117, 139);">Psicologa</p>
                  </div>
                </div>

                <!-- Patient Data -->
                <div class="mb-4">
                  <p class="font-bold text-xs mb-2" style="color: rgb(15, 23, 41);">DATOS DEL PACIENTE</p>
                  <p class="text-xs mb-1">
                    {{ isMinor() ? 'El/La menor' : 'D./Da.' }}
                    <strong>{{ registerForm.get('first_name')?.value || '________________' }} {{ registerForm.get('last_name')?.value || '________________' }}</strong>
                  </p>
                  <p class="text-xs mb-1">
                    Con DNI: <strong>{{ registerForm.get('dni')?.value || '________________' }}</strong>,
                    fecha de nacimiento: <strong>{{ registerForm.get('birth_date')?.value | date:'dd/MM/yyyy' }}</strong>
                  </p>
                  <p class="text-xs mb-1">
                    Domicilio: <strong>{{ registerForm.get('street')?.value || '________________' }} {{ registerForm.get('street_number')?.value }}{{ registerForm.get('door')?.value ? ', ' + registerForm.get('door')?.value : '' }}</strong>
                  </p>
                  <p class="text-xs mb-1">
                    CP: <strong>{{ registerForm.get('postal_code')?.value || '________' }}</strong>,
                    {{ registerForm.get('city')?.value || '________________' }} ({{ registerForm.get('province')?.value || '________________' }})
                  </p>
                  <p class="text-xs mb-1">
                    Telefono: <strong>{{ registerForm.get('phone')?.value || '________________' }}</strong>,
                    Email: <strong>{{ registerForm.get('email')?.value || '________________' }}</strong>
                  </p>
                </div>

                <!-- Guardian Data (only for minors) -->
                @if (isMinor()) {
                  <div class="mb-4 p-3 bg-amber-50 rounded border border-amber-200">
                    <p class="font-bold text-xs mb-2" style="color: rgb(15, 23, 41);">DATOS DE TUTORES/PROGENITORES</p>

                    <p class="text-xs mb-1">
                      <strong>Tutor 1:</strong> {{ registerForm.get('progenitor1_full_name')?.value || '________________________________' }}
                    </p>
                    <p class="text-xs mb-2">
                      DNI: {{ registerForm.get('progenitor1_dni')?.value || '________________' }},
                      Telf: {{ registerForm.get('progenitor1_phone')?.value || '________________' }}
                    </p>

                    @if (registerForm.get('progenitor2_full_name')?.value) {
                      <p class="text-xs mb-1">
                        <strong>Tutor 2:</strong> {{ registerForm.get('progenitor2_full_name')?.value }}
                      </p>
                      <p class="text-xs">
                        DNI: {{ registerForm.get('progenitor2_dni')?.value || '________________' }},
                        Telf: {{ registerForm.get('progenitor2_phone')?.value || '________________' }}
                      </p>
                    }
                  </div>
                }

                <!-- Checkboxes Preview -->
                <div class="mb-4">
                  <p class="font-bold text-xs mb-2" style="color: rgb(15, 23, 41);">CONSENTIMIENTOS</p>

                  @if (isMinor()) {
                    <div class="flex gap-2 mb-2">
                      <div class="flex-shrink-0 w-3 h-3 border border-gray-400 rounded-sm flex items-center justify-center" style="margin-top: 2px;">
                        @if (registerForm.get('consent_legal_representative')?.value) {
                          <span class="text-green-600 text-xs font-bold">&#10003;</span>
                        }
                      </div>
                      <p class="text-xs flex-1">Declaracion de tutor legal</p>
                    </div>
                  }

                  <div class="flex gap-2 mb-2">
                    <div class="flex-shrink-0 w-3 h-3 border border-gray-400 rounded-sm flex items-center justify-center" style="margin-top: 2px;">
                      @if (registerForm.get('consent_data_protection')?.value) {
                        <span class="text-green-600 text-xs font-bold">&#10003;</span>
                      }
                    </div>
                    <p class="text-xs flex-1">Proteccion de datos (RGPD)</p>
                  </div>

                  <div class="flex gap-2">
                    <div class="flex-shrink-0 w-3 h-3 border border-gray-400 rounded-sm flex items-center justify-center" style="margin-top: 2px;">
                      @if (registerForm.get('consent_service_conditions')?.value) {
                        <span class="text-green-600 text-xs font-bold">&#10003;</span>
                      }
                    </div>
                    <p class="text-xs flex-1">Condiciones del servicio</p>
                  </div>
                </div>

                <!-- Signatures Preview -->
                <div class="mt-6 pt-4 border-t">
                  <p class="font-bold text-xs mb-3" style="color: rgb(15, 23, 41);">FIRMAS</p>
                  <p class="text-xs mb-4" style="color: rgb(101, 117, 139);">
                    Fecha de firma: {{ currentDate | date:'dd/MM/yyyy' }}
                  </p>

                  <div class="grid grid-cols-2 gap-4">
                    <!-- Patient Signature -->
                    <div>
                      <p class="text-xs font-semibold mb-1">Firma del paciente:</p>
                      <div class="h-12 border-b border-gray-300 flex items-end justify-center">
                        @if (signatures.has('patient')) {
                          <img [src]="signatures.get('patient')" class="h-10 object-contain" alt="Firma paciente">
                        }
                      </div>
                    </div>

                    <!-- Guardian 1 Signature -->
                    @if (isMinor()) {
                      <div>
                        <p class="text-xs font-semibold mb-1">Firma tutor 1:</p>
                        <div class="h-12 border-b border-gray-300 flex items-end justify-center">
                          @if (signatures.has('guardian1')) {
                            <img [src]="signatures.get('guardian1')" class="h-10 object-contain" alt="Firma tutor 1">
                          }
                        </div>
                      </div>
                    }
                  </div>

                  @if (isMinor() && registerForm.get('progenitor2_full_name')?.value) {
                    <div class="mt-4">
                      <p class="text-xs font-semibold mb-1">Firma tutor 2:</p>
                      <div class="h-12 border-b border-gray-300 flex items-end justify-center w-1/2">
                        @if (signatures.has('guardian2')) {
                          <img [src]="signatures.get('guardian2')" class="h-10 object-contain" alt="Firma tutor 2">
                        }
                      </div>
                    </div>
                  }
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  }
</div>
